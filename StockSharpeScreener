import yfinance as yf
import pandas as pd
from datetime import datetime, timedelta
import numpy as np

def get_earnings_analysis(tickers):
    """
    Analyzes earnings surprise and price reaction for a list of tickers 
    over the last 2 years.
    
    Metrics:
    - Average Earnings Surprise (%): (Actual - Est) / Abs(Est)
    - Average Price Change (%): HPR from 1 day before to 2 days after earnings.
    """
    
    results = []
    
    # Define time window (2 years ago to today)
    end_date = datetime.now()
    start_date = end_date - timedelta(days=730)
    
    print(f"Analyzing {len(tickers)} tickers... this may take a moment.")
    print("-" * 60)

    for ticker_symbol in tickers:
        try:
            # 1. Fetch Ticker Object
            ticker = yf.Ticker(ticker_symbol)
            
            # 2. Get Earnings Dates (Limit 20 covers >2 years of quarterly reports)
            # This returns a DataFrame with columns like 'EPS Estimate', 'Reported EPS', 'Surprise(%)'
            earnings = ticker.get_earnings_dates(limit=24)
            
            if earnings is None or earnings.empty:
                print(f"Skipping {ticker_symbol}: No earnings dates found.")
                continue

            # Filter for last 2 years only
            # Note: Index is usually timezone-aware, we convert to naive for comparison
            earnings.index = earnings.index.tz_localize(None) 
            earnings = earnings[(earnings.index >= start_date) & (earnings.index <= end_date)]
            
            # Remove rows where Reported EPS is missing (future dates)
            earnings = earnings.dropna(subset=['Reported EPS'])
            
            if earnings.empty:
                print(f"Skipping {ticker_symbol}: No earnings in the last 2 years.")
                continue

            # 3. Fetch Price History for the full window to minimize API calls
            # We add a buffer to start_date to ensure we have the T-1 price
            price_history = ticker.history(start=start_date - timedelta(days=10), end=end_date)
            price_history.index = price_history.index.tz_localize(None) # Make naive
            print("printing surprise earnings...")
            surprises = []
            price_changes = []

            for date, row in earnings.iterrows():
                # Extract Earnings Surprise
                # Prefer 'Surprise(%)' column if exists, else calculate
                if 'Surprise(%)' in earnings.columns and not pd.isna(row['Surprise(%)']):
                    surprise = row['Surprise(%)']
                else:
                    # Manual Calculation: (Actual - Est) / |Est|
                    est = row['EPS Estimate']
                    actual = row['Reported EPS']
                    if pd.isna(est) or est == 0:
                        surprise = np.nan
                    else:
                        surprise = (actual - est) / abs(est)

                # Debug: print each earnings surprise instance for inspection
                try:
                    print(f"{ticker_symbol} {date.date()} surprise: {surprise}")
                except Exception:
                    # Defensive: ensure printing errors don't break the loop
                    print(f"{ticker_symbol} {date} surprise: <unprintable>")
                else:
                    # Manual Calculation: (Actual - Est) / |Est|
                    est = row['EPS Estimate']
                    actual = row['Reported EPS']
                    if pd.isna(est) or est == 0:
                        surprise = np.nan
                    else:
                        surprise = (actual - est) / abs(est)

                # Calculate Price Change (T-1 to T+2)
                # We interpret "days" as trading days. 
                # We find the location of the earnings date in the price history.
                
                # Check if exact date exists in price history (it might be a weekend/holiday)
                # If not, roll forward to the next trading day for the 'Announcement' reference
                try:
                    # Get integer location of the closest date >= earnings date
                    idx = price_history.index.searchsorted(date)
                    
                    if idx >= len(price_history):
                        continue # Date is too recent, no price data yet
                        
                    # Define indices for T-1 and T+2 relative to the announcement trading day
                    idx_start = idx - 1
                    idx_end = idx + 2
                    
                    # Ensure indices are within bounds
                    if idx_start < 0 or idx_end >= len(price_history):
                        continue

                    price_before = price_history.iloc[idx_start]['Close']
                    price_after = price_history.iloc[idx_end]['Close']
                    
                    # Holding Period Return
                    hpr = (price_after - price_before) / price_before
                    
                    surprises.append(surprise)
                    price_changes.append(hpr)
                    
                except Exception as e:
                    continue

            # 4. Compute Averages
            if surprises and price_changes:
                avg_surprise = np.nanmean(surprises)
                # Convert decimal to percentage for display (e.g., 0.05 -> 5.0%)
                avg_price_change = np.nanmean(price_changes) 
                
                results.append({
                    "Ticker": ticker_symbol,
                    "Avg Earnings Surprise": avg_surprise, # Already in % if from YF, or decimal if calc'd
                    "Avg Price Change (T-1 to T+2)": avg_price_change
                })

        except Exception as e:
            print(f"Error processing {ticker_symbol}: {e}")

    # 5. Create Final DataFrame
    df_results = pd.DataFrame(results)
    
    # Formatting for cleaner output
    if not df_results.empty:
        # Standardize Surprise: If YF gave decimals (0.10), make %, if it gave whole numbers (10), keep.
        # usually YF 'Surprise(%)' is e.g. 0.05 for 5%. We will assume decimals for calculation consistency.
        
        # Display as percentages strings
        pd.options.display.float_format = '{:.2%}'.format
    
    return df_results

# --- MAIN EXECUTION ---
if __name__ == "__main__":
    # Input your tickers here
    my_tickers = ['psmt', 'tsm', 'ibkr', 'stx', 'nflx', 'sofi', 'sap', 'lmt', 'asml', 'meta', 'pltr', 'amd', 'amzn', 'nvda', 'msft', 'orcl', 'air', 'jpm', 'bac', 'c', 'wfc', 'gs', 'ms', 'tsla', 'mtb', 'blk', 'wabc']
    
    df = get_earnings_analysis(my_tickers)
    
    print("\n" + "="*50)
    print("EARNINGS IMPACT ANALYSIS (LAST 2 YEARS)")
    print("="*50)
    print(df.to_string(index=False))